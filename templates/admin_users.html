{% extends "admin_layout.html" %}

{% block title %}Manage Users{% endblock %}

{% block content %}
<div class="admin-header enhanced-header">
    <div class="container">
        <div class="header-content">
            <div class="header-text">
                <h1><i class="fas fa-users gradient-icon"></i> User Management</h1>
                <p class="header-subtitle">Manage all registered users and their accounts with advanced controls</p>
            </div>
            <div class="header-actions">
                <button class="btn-admin btn-primary" onclick="showAddUserModal()">
                    <i class="fas fa-user-plus"></i> Add User
                </button>
                <button class="btn-admin btn-secondary" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<div class="admin-card enhanced-search-card">
    <div class="card-header">
        <h3><i class="fas fa-search"></i> Search & Filter Users</h3>
        <div class="card-actions">
            <button class="btn-icon" onclick="clearFilters()" title="Clear all filters">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    <div class="search-controls">
        <div class="search-group">
            <div class="input-group">
                <i class="fas fa-search input-icon"></i>
                <input type="text" id="searchUsers" placeholder="Search by username, email..." class="enhanced-input">
            </div>
        </div>
        <div class="filter-group">
            <select id="filterStatus" class="enhanced-select">
                <option value="">All Users</option>
                <option value="active">Active Users</option>
                <option value="inactive">Inactive Users</option>
            </select>
            <select id="filterResumes" class="enhanced-select">
                <option value="">All Resume Counts</option>
                <option value="0">No Resumes</option>
                <option value="1-5">1-5 Resumes</option>
                <option value="6+">6+ Resumes</option>
            </select>
        </div>
        <div class="action-group">
            <button onclick="exportUsers()" class="btn-admin btn-info">
                <i class="fas fa-download"></i> Export CSV
            </button>
            <button onclick="bulkActions()" class="btn-admin btn-warning">
                <i class="fas fa-tasks"></i> Bulk Actions
            </button>
        </div>
    </div>
</div>

<div class="admin-card enhanced-stats-card">
    <div class="card-header">
        <h3><i class="fas fa-chart-bar"></i> User Statistics</h3>
        <div class="card-actions">
            <button class="btn-icon" onclick="refreshStats()" title="Refresh statistics">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>
    <div class="stats-grid">
        <div class="stat-card stat-primary">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ stats.total_users }}</div>
                <div class="stat-label">Total Users</div>
                <div class="stat-trend">
                    <i class="fas fa-arrow-up"></i>
                    <span>+12% this month</span>
                </div>
            </div>
        </div>
        <div class="stat-card stat-success">
            <div class="stat-icon">
                <i class="fas fa-user-check"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ stats.active_users }}</div>
                <div class="stat-label">Active Users</div>
                <div class="stat-trend">
                    <i class="fas fa-arrow-up"></i>
                    <span>+8% this week</span>
                </div>
            </div>
        </div>
        <div class="stat-card stat-warning">
            <div class="stat-icon">
                <i class="fas fa-file-alt"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ stats.users_with_resumes }}</div>
                <div class="stat-label">Users with Resumes</div>
                <div class="stat-trend">
                    <i class="fas fa-arrow-up"></i>
                    <span>+15% this week</span>
                </div>
            </div>
        </div>
        <div class="stat-card stat-info">
            <div class="stat-icon">
                <i class="fas fa-calendar-plus"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ stats.recent_registrations }}</div>
                <div class="stat-label">New This Week</div>
                <div class="stat-trend">
                    <i class="fas fa-arrow-down"></i>
                    <span>-3% vs last week</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="admin-card enhanced-table-card">
    <div class="card-header">
        <h3><i class="fas fa-list"></i> All Users</h3>
        <div class="card-actions">
            <div class="table-controls">
                <button class="btn-icon" onclick="toggleTableView()" title="Toggle table view">
                    <i class="fas fa-th-list"></i>
                </button>
                <button class="btn-icon" onclick="selectAllUsers()" title="Select all users">
                    <i class="fas fa-check-square"></i>
                </button>
            </div>
        </div>
    </div>
    <div class="table-wrapper">
        <div class="table-toolbar">
            <div class="selected-count" id="selectedCount" style="display: none;">
                <span id="selectedNumber">0</span> users selected
            </div>
            <div class="table-actions">
                <button class="btn-sm btn-danger" onclick="bulkDelete()" style="display: none;" id="bulkDeleteBtn">
                    <i class="fas fa-trash"></i> Delete Selected
                </button>
                <button class="btn-sm btn-warning" onclick="bulkDeactivate()" style="display: none;" id="bulkDeactivateBtn">
                    <i class="fas fa-pause"></i> Deactivate Selected
                </button>
            </div>
        </div>
        <div class="admin-table enhanced-table">
            <table id="usersTable">
                <thead>
                    <tr>
                        <th class="checkbox-column">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                        </th>
                        <th class="sortable" onclick="sortTable('user')">
                            User <i class="fas fa-sort"></i>
                        </th>
                        <th class="sortable" onclick="sortTable('date')">
                            Registration Date <i class="fas fa-sort"></i>
                        </th>
                        <th class="sortable" onclick="sortTable('resumes')">
                            Resumes <i class="fas fa-sort"></i>
                        </th>
                        <th class="sortable" onclick="sortTable('activity')">
                            Last Activity <i class="fas fa-sort"></i>
                        </th>
                        <th class="sortable" onclick="sortTable('status')">
                            Status <i class="fas fa-sort"></i>
                        </th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr data-username="{{ user.username }}" data-status="{{ user.status }}" class="user-row">
                        <td class="checkbox-column">
                            <input type="checkbox" class="user-checkbox" value="{{ user.username }}" onchange="updateSelection()">
                        </td>
                        <td>
                            <div class="user-info">
                                <div class="user-avatar">
                                    {{ user.username[0].upper() }}
                                </div>
                                <div class="user-details">
                                    <div class="user-name">{{ user.username }}</div>
                                    <div class="user-email">{{ user.email or 'No email' }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="date-info">
                                <div class="date-primary">{{ user.registration_date or 'N/A' }}</div>
                                <div class="date-secondary">{{ user.days_since_registration }} days ago</div>
                            </div>
                        </td>
                        <td>
                            <span class="enhanced-badge badge-{% if user.resume_count > 0 %}success{% else %}secondary{% endif %}">
                                <i class="fas fa-file-alt"></i>
                                {{ user.resume_count }} resume{{ 's' if user.resume_count != 1 else '' }}
                            </span>
                        </td>
                        <td>
                            <div class="activity-info">
                                <div class="activity-primary">{{ user.last_activity or 'Never' }}</div>
                                {% if user.last_activity %}
                                <div class="activity-indicator active"></div>
                                {% else %}
                                <div class="activity-indicator inactive"></div>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <span class="enhanced-badge badge-{% if user.status == 'active' %}success{% else %}danger{% endif %}">
                                <i class="fas {% if user.status == 'active' %}fa-check-circle{% else %}fa-times-circle{% endif %}"></i>
                                {{ user.status.title() }}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <div class="btn-group">
                                    <a href="/admin/users/{{ user.username }}" class="btn-action btn-info" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <button onclick="editUser('{{ user.username }}')" class="btn-action btn-primary" title="Edit User">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="toggleUserStatus('{{ user.username }}', '{{ user.status }}')"
                                            class="btn-action {% if user.status == 'active' %}btn-warning{% else %}btn-success{% endif %}"
                                            title="{% if user.status == 'active' %}Deactivate{% else %}Activate{% endif %} User">
                                        <i class="fas {% if user.status == 'active' %}fa-pause{% else %}fa-play{% endif %}"></i>
                                    </button>
                                    <div class="dropdown">
                                        <button class="btn-action btn-secondary dropdown-toggle" onclick="toggleDropdown(this)">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <div class="dropdown-menu">
                                            <a href="#" onclick="resetPassword('{{ user.username }}')">
                                                <i class="fas fa-key"></i> Reset Password
                                            </a>
                                            <a href="#" onclick="viewUserActivity('{{ user.username }}')">
                                                <i class="fas fa-history"></i> View Activity
                                            </a>
                                            <div class="dropdown-divider"></div>
                                            <a href="#" onclick="deleteUser('{{ user.username }}')" class="text-danger">
                                                <i class="fas fa-trash"></i> Delete User
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Enhanced User Details Modal -->
<div class="modal fade enhanced-modal" id="userModal" tabindex="-1" style="display: none;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title-group">
                    <h5 class="modal-title">
                        <i class="fas fa-user-circle"></i>
                        User Details
                    </h5>
                    <span class="modal-subtitle">Comprehensive user information</span>
                </div>
                <button type="button" class="btn-close enhanced-close" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body enhanced-modal-body" id="userModalContent">
                <!-- Content will be loaded here -->
                <div class="loading-spinner" id="modalLoading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>Loading user details...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade enhanced-modal" id="addUserModal" tabindex="-1" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title-group">
                    <h5 class="modal-title">
                        <i class="fas fa-user-plus"></i>
                        Add New User
                    </h5>
                    <span class="modal-subtitle">Create a new user account</span>
                </div>
                <button type="button" class="btn-close enhanced-close" onclick="closeAddUserModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body enhanced-modal-body">
                <form id="addUserForm" class="enhanced-form">
                    <div class="form-group">
                        <label for="newUsername">Username</label>
                        <input type="text" id="newUsername" name="username" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="newEmail">Email</label>
                        <input type="email" id="newEmail" name="email" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="newPassword">Password</label>
                        <input type="password" id="newPassword" name="password" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="userStatus">Status</label>
                        <select id="userStatus" name="status" class="form-control">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-admin btn-secondary" onclick="closeAddUserModal()">Cancel</button>
                <button type="button" class="btn-admin btn-primary" onclick="submitAddUser()">
                    <i class="fas fa-plus"></i> Create User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Delete Confirmation Modal -->
<div class="modal fade enhanced-modal" id="deleteModal" tabindex="-1" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header danger-header">
                <div class="modal-title-group">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        Confirm Delete
                    </h5>
                    <span class="modal-subtitle">This action cannot be undone</span>
                </div>
                <button type="button" class="btn-close enhanced-close" onclick="closeDeleteModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body enhanced-modal-body">
                <div class="warning-content">
                    <div class="warning-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="warning-text">
                        <p>Are you sure you want to delete this user? This action cannot be undone and will remove all associated data including resumes.</p>
                    </div>
                </div>
                <div class="danger-alert">
                    <div class="alert-header">
                        <i class="fas fa-shield-alt"></i>
                        <strong>Warning: Permanent Data Loss</strong>
                    </div>
                    <div class="alert-content">
                        <p>This will permanently delete:</p>
                        <ul class="danger-list">
                            <li><i class="fas fa-user"></i> User account and profile</li>
                            <li><i class="fas fa-file-alt"></i> All uploaded resumes</li>
                            <li><i class="fas fa-paper-plane"></i> Application history</li>
                            <li><i class="fas fa-chart-line"></i> Analysis results</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-admin btn-secondary" onclick="closeDeleteModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn-admin btn-danger" id="confirmDelete">
                    <i class="fas fa-trash"></i> Delete User
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let userToDelete = null;

// Enhanced search functionality
document.getElementById('searchUsers').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('#usersTable tbody tr');

    rows.forEach(row => {
        const username = row.dataset.username.toLowerCase();
        const userEmail = row.querySelector('.user-email').textContent.toLowerCase();

        if (username.includes(searchTerm) || userEmail.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    updateVisibleCount();
});

// Enhanced filter functionality
document.getElementById('filterStatus').addEventListener('change', function() {
    applyFilters();
});

document.getElementById('filterResumes').addEventListener('change', function() {
    applyFilters();
});

function applyFilters() {
    const statusFilter = document.getElementById('filterStatus').value;
    const resumeFilter = document.getElementById('filterResumes').value;
    const rows = document.querySelectorAll('#usersTable tbody tr');

    rows.forEach(row => {
        const status = row.dataset.status;
        const resumeText = row.querySelector('.enhanced-badge').textContent;
        const resumeCount = parseInt(resumeText.match(/\d+/)[0]);

        let showRow = true;

        // Status filter
        if (statusFilter && status !== statusFilter) {
            showRow = false;
        }

        // Resume count filter
        if (resumeFilter) {
            if (resumeFilter === '0' && resumeCount !== 0) {
                showRow = false;
            } else if (resumeFilter === '1-5' && (resumeCount < 1 || resumeCount > 5)) {
                showRow = false;
            } else if (resumeFilter === '6+' && resumeCount < 6) {
                showRow = false;
            }
        }

        row.style.display = showRow ? '' : 'none';
    });
    updateVisibleCount();
}

function updateVisibleCount() {
    const visibleRows = document.querySelectorAll('#usersTable tbody tr[style=""], #usersTable tbody tr:not([style*="none"])');
    const totalRows = document.querySelectorAll('#usersTable tbody tr').length;

    // You can add a counter display here if needed
    console.log(`Showing ${visibleRows.length} of ${totalRows} users`);
}

function clearFilters() {
    document.getElementById('searchUsers').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterResumes').value = '';

    const rows = document.querySelectorAll('#usersTable tbody tr');
    rows.forEach(row => {
        row.style.display = '';
    });
    updateVisibleCount();
}

// Selection functionality
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.user-checkbox');

    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });

    updateSelection();
}

function updateSelection() {
    const checkboxes = document.querySelectorAll('.user-checkbox');
    const checkedBoxes = document.querySelectorAll('.user-checkbox:checked');
    const selectAll = document.getElementById('selectAll');

    // Update select all checkbox
    if (checkedBoxes.length === 0) {
        selectAll.indeterminate = false;
        selectAll.checked = false;
    } else if (checkedBoxes.length === checkboxes.length) {
        selectAll.indeterminate = false;
        selectAll.checked = true;
    } else {
        selectAll.indeterminate = true;
        selectAll.checked = false;
    }

    // Show/hide bulk actions
    const selectedCount = document.getElementById('selectedCount');
    const selectedNumber = document.getElementById('selectedNumber');
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    const bulkDeactivateBtn = document.getElementById('bulkDeactivateBtn');

    if (checkedBoxes.length > 0) {
        selectedCount.style.display = 'block';
        selectedNumber.textContent = checkedBoxes.length;
        bulkDeleteBtn.style.display = 'inline-block';
        bulkDeactivateBtn.style.display = 'inline-block';
    } else {
        selectedCount.style.display = 'none';
        bulkDeleteBtn.style.display = 'none';
        bulkDeactivateBtn.style.display = 'none';
    }
}

// Table sorting
let sortDirection = {};

function sortTable(column) {
    const table = document.getElementById('usersTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    // Toggle sort direction
    sortDirection[column] = sortDirection[column] === 'asc' ? 'desc' : 'asc';

    rows.sort((a, b) => {
        let aValue, bValue;

        switch(column) {
            case 'user':
                aValue = a.querySelector('.user-name').textContent.toLowerCase();
                bValue = b.querySelector('.user-name').textContent.toLowerCase();
                break;
            case 'date':
                aValue = a.querySelector('.date-primary').textContent;
                bValue = b.querySelector('.date-primary').textContent;
                break;
            case 'resumes':
                aValue = parseInt(a.querySelector('.enhanced-badge').textContent.match(/\d+/)[0]);
                bValue = parseInt(b.querySelector('.enhanced-badge').textContent.match(/\d+/)[0]);
                break;
            case 'activity':
                aValue = a.querySelector('.activity-primary').textContent;
                bValue = b.querySelector('.activity-primary').textContent;
                break;
            case 'status':
                aValue = a.dataset.status;
                bValue = b.dataset.status;
                break;
        }

        if (sortDirection[column] === 'asc') {
            return aValue > bValue ? 1 : -1;
        } else {
            return aValue < bValue ? 1 : -1;
        }
    });

    // Re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));

    // Update sort indicators
    document.querySelectorAll('.sortable i').forEach(icon => {
        icon.className = 'fas fa-sort';
    });

    const currentIcon = document.querySelector(`th[onclick="sortTable('${column}')"] i`);
    if (currentIcon) {
        currentIcon.className = sortDirection[column] === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
    }
}

function toggleUserStatus(username, currentStatus) {
    const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
    const action = newStatus === 'active' ? 'activate' : 'deactivate';

    if (confirm(`Are you sure you want to ${action} user "${username}"?`)) {
        fetch(`/admin/users/${username}/toggle-status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'Error updating user status');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating user status');
        });
    }
}

function deleteUser(username) {
    userToDelete = username;
    document.getElementById('deleteModal').style.display = 'block';
}

function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
    userToDelete = null;
}

function closeModal() {
    document.getElementById('userModal').style.display = 'none';
}

document.getElementById('confirmDelete').addEventListener('click', function() {
    if (!userToDelete) return;

    fetch(`/admin/users/${userToDelete}/delete`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'Error deleting user');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting user');
    });
});

function exportUsers() {
    window.location.href = '/admin/users/export';
}

// New enhanced functions
function showAddUserModal() {
    document.getElementById('addUserModal').style.display = 'block';
}

function closeAddUserModal() {
    document.getElementById('addUserModal').style.display = 'none';
    document.getElementById('addUserForm').reset();
}

function submitAddUser() {
    const form = document.getElementById('addUserForm');
    const formData = new FormData(form);

    // Basic validation
    const password = formData.get('password');
    const confirmPassword = formData.get('confirmPassword');

    if (password !== confirmPassword) {
        alert('Passwords do not match!');
        return;
    }

    // Send data to server
    const userData = {
        username: formData.get('username'),
        email: formData.get('email'),
        password: password,
        status: formData.get('status')
    };

    fetch('/admin/users/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(userData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('User created successfully!');
            closeAddUserModal();
            location.reload();
        } else {
            alert(data.error || 'Error creating user');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating user');
    });
}

function refreshData() {
    location.reload();
}

function refreshStats() {
    // Animate the stats refresh
    const statNumbers = document.querySelectorAll('.stat-number');
    statNumbers.forEach(stat => {
        stat.style.opacity = '0.5';
        setTimeout(() => {
            stat.style.opacity = '1';
        }, 500);
    });
}

function bulkActions() {
    const checkedBoxes = document.querySelectorAll('.user-checkbox:checked');
    if (checkedBoxes.length === 0) {
        alert('Please select users first');
        return;
    }

    const usernames = Array.from(checkedBoxes).map(cb => cb.value);
    console.log('Bulk actions for users:', usernames);
    alert('Bulk actions functionality would be implemented here');
}

function bulkDelete() {
    const checkedBoxes = document.querySelectorAll('.user-checkbox:checked');
    if (checkedBoxes.length === 0) {
        alert('Please select users first');
        return;
    }

    const usernames = Array.from(checkedBoxes).map(cb => cb.value);
    if (confirm(`Are you sure you want to delete ${usernames.length} users? This action cannot be undone.`)) {
        fetch('/admin/users/bulk-delete', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ usernames: usernames })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Successfully deleted ${data.deleted_count} users`);
                location.reload();
            } else {
                alert(data.error || 'Error deleting users');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting users');
        });
    }
}

function bulkDeactivate() {
    const checkedBoxes = document.querySelectorAll('.user-checkbox:checked');
    if (checkedBoxes.length === 0) {
        alert('Please select users first');
        return;
    }

    const usernames = Array.from(checkedBoxes).map(cb => cb.value);
    if (confirm(`Are you sure you want to deactivate ${usernames.length} users?`)) {
        console.log('Bulk deactivate users:', usernames);
        alert('Bulk deactivate functionality would be implemented here');
    }
}

function editUser(username) {
    console.log('Edit user:', username);
    alert('Edit user functionality would be implemented here');
}

function resetPassword(username) {
    if (confirm(`Are you sure you want to reset the password for user "${username}"?`)) {
        fetch(`/admin/users/${username}/reset-password`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Password reset successfully! New temporary password: ${data.temporary_password}\n\nPlease provide this to the user and ask them to change it on next login.`);
            } else {
                alert(data.error || 'Error resetting password');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error resetting password');
        });
    }
}

function viewUserActivity(username) {
    console.log('View activity for user:', username);
    alert('User activity view functionality would be implemented here');
}

function toggleTableView() {
    const table = document.querySelector('.enhanced-table');
    table.classList.toggle('compact-view');
}

function selectAllUsers() {
    const selectAll = document.getElementById('selectAll');
    selectAll.checked = true;
    toggleSelectAll();
}

// Dropdown functionality
function toggleDropdown(button) {
    const dropdown = button.nextElementSibling;
    const isOpen = dropdown.classList.contains('show');

    // Close all dropdowns
    document.querySelectorAll('.dropdown-menu').forEach(menu => {
        menu.classList.remove('show');
    });

    // Toggle current dropdown
    if (!isOpen) {
        dropdown.classList.add('show');
    }
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('.dropdown')) {
        document.querySelectorAll('.dropdown-menu').forEach(menu => {
            menu.classList.remove('show');
        });
    }
});

// Close modals when clicking outside
window.addEventListener('click', function(event) {
    const deleteModal = document.getElementById('deleteModal');
    const userModal = document.getElementById('userModal');
    const addUserModal = document.getElementById('addUserModal');

    if (event.target === deleteModal) {
        closeDeleteModal();
    }
    if (event.target === userModal) {
        closeModal();
    }
    if (event.target === addUserModal) {
        closeAddUserModal();
    }
});

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    updateVisibleCount();

    // Add loading states to buttons
    document.querySelectorAll('.btn-admin').forEach(btn => {
        btn.addEventListener('click', function() {
            if (!this.classList.contains('no-loading')) {
                this.style.opacity = '0.7';
                setTimeout(() => {
                    this.style.opacity = '1';
                }, 1000);
            }
        });
    });
});
</script>

<style>
/* Enhanced Admin Users Styles */

/* Improved Color Variables for Better Contrast */
:root {
    --enhanced-text-primary: #1a202c;
    --enhanced-text-secondary: #4a5568;
    --enhanced-text-light: #718096;
    --enhanced-bg-primary: rgba(255, 255, 255, 0.98);
    --enhanced-bg-secondary: rgba(247, 250, 252, 0.95);
    --enhanced-border: rgba(226, 232, 240, 0.8);
    --enhanced-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

/* Header Enhancements */
.enhanced-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    margin-bottom: 30px;
    overflow: hidden;
    box-shadow: var(--enhanced-shadow);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 20px;
}

.header-text h1 {
    color: white;
    margin: 0;
    font-size: 2.2rem;
    font-weight: 700;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.gradient-icon {
    background: linear-gradient(45deg, #ffd700, #ffed4e);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3));
}

.header-subtitle {
    color: rgba(255, 255, 255, 0.95);
    font-size: 1.1rem;
    margin: 5px 0 0 0;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
}

.header-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

/* Enhanced Search Card */
.enhanced-search-card {
    background: var(--enhanced-bg-primary);
    backdrop-filter: blur(10px);
    border: 1px solid var(--enhanced-border);
    box-shadow: var(--enhanced-shadow);
}

.enhanced-search-card .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--enhanced-border);
}

.enhanced-search-card h3 {
    color: var(--enhanced-text-primary);
    font-weight: 600;
}

.card-actions {
    display: flex;
    gap: 10px;
}

.btn-icon {
    background: var(--enhanced-bg-secondary);
    border: 1px solid var(--enhanced-border);
    border-radius: 8px;
    padding: 8px 10px;
    cursor: pointer;
    transition: var(--transition);
    color: var(--enhanced-text-primary);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.btn-icon:hover {
    background: var(--admin-primary);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(229, 62, 62, 0.3);
}

.search-controls {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr;
    gap: 20px;
    align-items: end;
}

.input-group {
    position: relative;
}

.input-icon {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-light);
    z-index: 1;
}

.enhanced-input {
    width: 100%;
    padding: 12px 12px 12px 40px;
    border: 2px solid var(--enhanced-border);
    border-radius: 12px;
    background: var(--enhanced-bg-primary);
    backdrop-filter: blur(10px);
    transition: var(--transition);
    font-size: 14px;
    color: var(--enhanced-text-primary);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.enhanced-input::placeholder {
    color: var(--enhanced-text-light);
}

.enhanced-input:focus {
    outline: none;
    border-color: var(--admin-primary);
    box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.1), 0 1px 3px rgba(0, 0, 0, 0.1);
    background: white;
}

.enhanced-select {
    padding: 12px 15px;
    border: 2px solid var(--enhanced-border);
    border-radius: 12px;
    background: var(--enhanced-bg-primary);
    backdrop-filter: blur(10px);
    transition: var(--transition);
    cursor: pointer;
    color: var(--enhanced-text-primary);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.enhanced-select:focus {
    outline: none;
    border-color: var(--admin-primary);
    box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.1), 0 1px 3px rgba(0, 0, 0, 0.1);
    background: white;
}

.filter-group, .action-group {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

/* Enhanced Statistics */
.enhanced-stats-card {
    background: var(--enhanced-bg-primary);
    border: 1px solid var(--enhanced-border);
    box-shadow: var(--enhanced-shadow);
}

.enhanced-stats-card h3 {
    color: var(--enhanced-text-primary);
    font-weight: 600;
}

.enhanced-stats-card .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.stat-card {
    background: var(--enhanced-bg-primary);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 25px;
    border: 1px solid var(--enhanced-border);
    transition: var(--transition);
    position: relative;
    overflow: hidden;
    box-shadow: var(--enhanced-shadow);
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--admin-primary), var(--admin-primary-light));
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--box-shadow-lg);
}

.stat-card {
    display: flex;
    align-items: center;
    gap: 20px;
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
}

.stat-primary .stat-icon { background: linear-gradient(135deg, var(--admin-info), #4299e1); }
.stat-success .stat-icon { background: linear-gradient(135deg, var(--admin-success), #48bb78); }
.stat-warning .stat-icon { background: linear-gradient(135deg, var(--admin-warning), #ed8936); }
.stat-info .stat-icon { background: linear-gradient(135deg, var(--admin-purple), #805ad5); }

.stat-content {
    flex: 1;
}

.stat-number {
    font-size: 2.5rem;
    font-weight: 700;
    color: #1a202c;
    line-height: 1;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.stat-label {
    color: #4a5568;
    font-size: 0.9rem;
    margin: 5px 0;
    font-weight: 500;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.stat-trend {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.8rem;
    color: #38a169;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.stat-trend i {
    font-size: 0.7rem;
}

/* Enhanced Table */
.enhanced-table-card {
    background: var(--enhanced-bg-primary);
    border: 1px solid var(--enhanced-border);
    box-shadow: var(--enhanced-shadow);
}

.enhanced-table-card h3 {
    color: var(--enhanced-text-primary);
    font-weight: 600;
}

.enhanced-table-card .table-wrapper {
    background: var(--enhanced-bg-primary);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--enhanced-border);
    box-shadow: var(--enhanced-shadow);
}

.table-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background: var(--enhanced-bg-secondary);
    border-bottom: 1px solid var(--enhanced-border);
}

.selected-count {
    color: var(--admin-primary);
    font-weight: 600;
}

.table-actions {
    display: flex;
    gap: 10px;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 0.8rem;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    transition: var(--transition);
}

.enhanced-table table {
    width: 100%;
    border-collapse: collapse;
}

.enhanced-table th {
    background: var(--enhanced-bg-secondary);
    padding: 15px 12px;
    text-align: left;
    font-weight: 600;
    color: var(--enhanced-text-primary);
    border-bottom: 2px solid var(--enhanced-border);
    position: relative;
}

.sortable {
    cursor: pointer;
    user-select: none;
    transition: var(--transition);
}

.sortable:hover {
    background: rgba(102, 126, 234, 0.1);
    color: var(--admin-primary);
}

.sortable i {
    margin-left: 5px;
    opacity: 0.6;
    color: var(--enhanced-text-light);
}

.enhanced-table td {
    padding: 15px 12px;
    border-bottom: 1px solid var(--enhanced-border);
    vertical-align: middle;
    background: var(--enhanced-bg-primary);
}

.user-row:hover {
    background: var(--enhanced-bg-secondary);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.checkbox-column {
    width: 40px;
    text-align: center;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.user-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--admin-primary), var(--admin-primary-light));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 1.1rem;
}

.user-details {
    flex: 1;
}

.user-name {
    font-weight: 600;
    color: var(--enhanced-text-primary);
    margin-bottom: 2px;
}

.user-email {
    font-size: 0.85rem;
    color: var(--enhanced-text-light);
}

.date-info, .activity-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.date-primary, .activity-primary {
    color: var(--enhanced-text-primary);
    font-weight: 500;
}

.date-secondary {
    font-size: 0.8rem;
    color: var(--enhanced-text-light);
}

.activity-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-top: 2px;
}

.activity-indicator.active {
    background: var(--admin-success);
    box-shadow: 0 0 6px var(--admin-success);
}

.activity-indicator.inactive {
    background: var(--admin-secondary);
}

.enhanced-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
    color: white;
}

.badge-success { background: linear-gradient(135deg, var(--admin-success), #48bb78); }
.badge-danger { background: linear-gradient(135deg, var(--admin-danger), #f56565); }
.badge-secondary { background: linear-gradient(135deg, var(--admin-secondary), #a0aec0); }

.action-buttons .btn-group {
    display: flex;
    gap: 5px;
    align-items: center;
}

.btn-action {
    width: 35px;
    height: 35px;
    border-radius: 8px;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
    text-decoration: none;
    font-size: 0.9rem;
}

.btn-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.btn-info { background: var(--admin-info); color: white; }
.btn-primary { background: var(--admin-primary); color: white; }
.btn-warning { background: var(--admin-warning); color: white; }
.btn-success { background: var(--admin-success); color: white; }
.btn-secondary { background: var(--admin-secondary); color: white; }

.dropdown {
    position: relative;
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    right: 0;
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border);
    border-radius: 8px;
    min-width: 180px;
    box-shadow: var(--box-shadow);
    z-index: 1000;
    display: none;
}

.dropdown-menu.show {
    display: block;
}

.dropdown-menu a {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 15px;
    color: var(--text-color);
    text-decoration: none;
    transition: var(--transition);
}

.dropdown-menu a:hover {
    background: rgba(255, 255, 255, 0.1);
}

.dropdown-divider {
    height: 1px;
    background: var(--glass-border);
    margin: 5px 0;
}

.text-danger {
    color: var(--admin-danger) !important;
}

/* Enhanced Modals */
.enhanced-modal .modal-content {
    background: var(--enhanced-bg-primary);
    backdrop-filter: blur(20px);
    border: 1px solid var(--enhanced-border);
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
}

.enhanced-modal .modal-header {
    background: var(--enhanced-bg-secondary);
    border-bottom: 1px solid var(--enhanced-border);
    padding: 25px;
}

.modal-title-group {
    flex: 1;
}

.modal-title {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 0;
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--enhanced-text-primary);
}

.modal-subtitle {
    color: var(--enhanced-text-secondary);
    font-size: 0.9rem;
    margin-top: 5px;
}

.enhanced-close {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid var(--glass-border);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
    color: var(--text-color);
}

.enhanced-close:hover {
    background: var(--admin-danger);
    color: white;
    transform: rotate(90deg);
}

.enhanced-modal-body {
    padding: 25px;
}

.loading-spinner {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    padding: 40px;
    color: var(--text-light);
}

.loading-spinner i {
    font-size: 2rem;
    color: var(--admin-primary);
}

.enhanced-form .form-group {
    margin-bottom: 20px;
}

.enhanced-form label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--enhanced-text-primary);
}

.enhanced-form .form-control {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid var(--enhanced-border);
    border-radius: 10px;
    background: var(--enhanced-bg-primary);
    backdrop-filter: blur(10px);
    transition: var(--transition);
    color: var(--enhanced-text-primary);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.enhanced-form .form-control:focus {
    outline: none;
    border-color: var(--admin-primary);
    box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.1), 0 1px 3px rgba(0, 0, 0, 0.1);
    background: white;
}

.danger-header {
    background: linear-gradient(135deg, rgba(229, 62, 62, 0.1), rgba(229, 62, 62, 0.05));
}

.warning-content {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
}

.warning-icon {
    color: var(--admin-warning);
    font-size: 2rem;
}

.warning-text p {
    margin: 0;
    color: var(--enhanced-text-primary);
    font-weight: 500;
}

.danger-alert {
    background: rgba(229, 62, 62, 0.08);
    border: 1px solid rgba(229, 62, 62, 0.2);
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(229, 62, 62, 0.1);
}

.alert-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
    color: var(--admin-danger);
    font-weight: 600;
}

.danger-list {
    list-style: none;
    padding: 0;
    margin: 10px 0 0 0;
}

.danger-list li {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 5px 0;
    color: var(--enhanced-text-primary);
    font-weight: 500;
}

.danger-list i {
    color: var(--admin-danger);
    width: 16px;
}

/* Responsive Design */
@media (max-width: 1200px) {
    .search-controls {
        grid-template-columns: 1fr;
        gap: 15px;
    }

    .filter-group, .action-group {
        justify-content: stretch;
    }

    .filter-group select, .action-group button {
        flex: 1;
    }
}

@media (max-width: 768px) {
    .header-content {
        flex-direction: column;
        text-align: center;
    }

    .enhanced-table {
        overflow-x: auto;
    }

    .enhanced-table table {
        min-width: 800px;
    }

    .modal-dialog {
        width: 95%;
        margin: 10px;
    }

    .enhanced-modal .modal-header {
        padding: 20px;
    }

    .enhanced-modal-body {
        padding: 20px;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .stat-card {
        flex-direction: column;
        text-align: center;
    }
}

/* Animation Enhancements */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.admin-card {
    animation: fadeInUp 0.5s ease-out;
}

.admin-card:nth-child(2) { animation-delay: 0.1s; }
.admin-card:nth-child(3) { animation-delay: 0.2s; }
.admin-card:nth-child(4) { animation-delay: 0.3s; }

.modal.fade {
    opacity: 0;
    transition: opacity 0.3s ease;
}

.modal.fade.show {
    opacity: 1;
}

/* Enhanced Admin Card Base Styles */
.admin-card {
    background: var(--enhanced-bg-primary);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 25px;
    border: 1px solid var(--enhanced-border);
    box-shadow: var(--enhanced-shadow);
}

.admin-card h3 {
    color: var(--enhanced-text-primary);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
}

.admin-card h3 i {
    color: var(--admin-primary);
}

/* Legacy Modal Styles */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 2000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-dialog {
    max-width: 500px;
    width: 90%;
    margin: 0 auto;
}

.modal-lg {
    max-width: 800px;
}

.modal-content {
    padding: 0;
    border-radius: 15px;
    overflow: hidden;
}

.modal-header, .modal-footer {
    padding: 20px;
}

.modal-body {
    padding: 20px;
}

/* Input Icon Color Fix */
.input-icon {
    color: var(--enhanced-text-light);
}
</style>
{% endblock %}
